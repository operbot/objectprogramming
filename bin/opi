#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=C0115,C0116,R0201,C0413


"internet relay chat"


## import


import importlib
import os
import queue
import readline
import socket
import sys
import termios
import time
import textwrap
import threading
import _thread


sys.path.insert(0, os.getcwd())


from op import Class, Default, Object, Wd
from op import edit, keys, last, locked, printable, register, save
from op import Bus, Command, Event, Handler, command, launch, scan, scandir


from opm.irc import IRC


from opm import cmds, irc


## define


Wd.workdir = os.path.expanduser("~/.op")


starttime = time.time()


## class


class CLI(Handler):

    def raw(self, txt):
        print(txt)


class Shell(Handler):

    def loop(self):
        while 1:
            self.handle(self.poll())

    def poll(self):
        event = Event()
        event.bot = self
        event.txt = input("> ")
        event.orig = repr(self)
        return event

    def raw(self, txt):
        print(txt)

    def start(self):
        launch(self.loop)

    def wait(self):
        while 1:
            time.sleep(1.0)


## utility


def banner():
    print("OPI (Object Programming IRC) started at %s" % time.ctime(time.time()).replace("  ", " "))
    print(printable(irc.cfg, skip="password,username,realname"))


def importer(packagename, modulename):
    name = "%s.%s" % (packagename, modulename)
    try:
        mod = importlib.import_module(name, packagename)
        scan(cli, mod)
    except ModuleNotFoundError:
        pass


def wrap(func):
    fds = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fds)
    except termios.error:
        gotterm = False
    readline.redisplay()
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fds, termios.TCSADRAIN, old)


## runtime


cli = CLI()
irc = IRC()
shl = Shell()


def main():
    scandir("mod", importer)
    if len(sys.argv) > 1:
        return command(cli, " ".join(sys.argv[1:]))
    banner()
    scan(cmds)
    scan(irc)
    irc.start()
    shl.start()
    shl.wait()


if __name__ == "__main__":
    wrap(main)
